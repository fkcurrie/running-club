---
import Layout from '../layouts/Layout.astro';
---

<Layout title="My Profile">
  <h1>Update Your Information</h1>

  <article id="profile-form-container">
    <p aria-busy="true">Loading your profile...</p>
  </article>
</Layout>

<script type="module">
  import { createClient } from '@supabase/supabase-js';
  import { Toast } from 'simple-toasts';

  const body = document.querySelector('body');
  const supabaseUrl = body.dataset.supabaseUrl;
  const supabaseAnonKey = body.dataset.supabaseAnonKey;

  if (!supabaseUrl || !supabaseAnonKey) {
    console.error("Supabase credentials not found in the DOM.");
  } else {
    const supabase = createClient(supabaseUrl, supabaseAnonKey);
    const formContainer = document.getElementById('profile-form-container');
    let user = null;

    // --- 1. Fetch Profile Data and Display Form ---
    async function fetchAndDisplayForm() {
      const { data: { user: authUser } } = await supabase.auth.getUser();
      if (!authUser) {
        window.location.href = '/login';
        return;
      }
      user = authUser;

      const { data: profile, error } = await supabase
        .from('profiles')
        .select('full_name, grade')
        .eq('id', user.id)
        .single();

      if (error || !profile) {
        console.error("Error fetching profile:", error);
        formContainer.innerHTML = '<p>Could not load your profile data.</p>';
        return;
      }

      formContainer.innerHTML = `
        <form id="profile-form">
          <label for="email">Email (read-only)</label>
          <input type="email" id="email" name="email" value="${user.email}" readonly>

          <label for="full_name">Full Name</label>
          <input type="text" id="full_name" name="full_name" value="${profile.full_name || ''}" required>
          
          <label for="grade">Grade</label>
          <input type="number" id="grade" name="grade" value="${profile.grade || ''}" required>
          
          <button type="submit">Update Profile</button>
        </form>
      `;

      document.getElementById('profile-form').addEventListener('submit', handleUpdate);
    }

    // --- 2. Handle Form Submission ---
    async function handleUpdate(event) {
      event.preventDefault();
      const form = event.currentTarget;
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.innerHTML = '<span aria-busy="true">Updating...</span>';

      const formData = new FormData(form);
      
      const updatedData = {
        full_name: formData.get('full_name'),
        grade: formData.get('grade'),
      };

      const { error } = await supabase
        .from('profiles')
        .update(updatedData)
        .eq('id', user.id);

      if (error) {
        new Toast({
          message: `Error: ${error.message}`,
          type: 'error',
        });
      } else {
        new Toast({
          message: 'Profile updated successfully!',
          type: 'success',
        });
      }
      submitButton.disabled = false;
      submitButton.innerHTML = 'Update Profile';
    }

    fetchAndDisplayForm();
  }
</script>