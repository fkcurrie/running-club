---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Schedule">
  <h1>Upcoming Events</h1>
  <p>This schedule is for members only. Welcome!</p>

  <div id="calendar"></div>
</Layout>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  import { VanillaCalendar } from 'https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.9.2/+esm'

  const body = document.querySelector('body');
  const supabaseUrl = body.dataset.supabaseUrl;
  const supabaseAnonKey = body.dataset.supabaseAnonKey;

  if (!supabaseUrl || !supabaseAnonKey) {
    console.error("Supabase credentials not found in the DOM.");
  } else {
    const supabase = createClient(supabaseUrl, supabaseAnonKey);
    const adminLink = document.getElementById('admin-link');
    let currentUser = null;

    async function fetchAndDisplayEvents() {
      const { data: events, error } = await supabase
        .from('events')
        .select('*')
        .order('event_date', { ascending: true });

      if (error) {
        console.error("Error fetching events:", error);
        return;
      }

      const calendarOptions = {
        actions: {
          clickDay(e, self) {
            console.log(self.selectedDates);
          },
        },
        settings: {
          visibility: {
            theme: 'light',
          },
        },
        events: events.map(event => ({
          start: event.event_date,
          title: event.title,
          description: event.description,
        })),
      };
      const calendar = new VanillaCalendar('#calendar', calendarOptions);
      calendar.init();
    }

    async function checkSessionAndLoadData() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { window.location.href = '/login'; return; }
      currentUser = user;
      fetchAndDisplayEvents();
      const { data: profile } = await supabase.from('profiles').select('is_admin').eq('id', user.id).single();
      if (profile && profile.is_admin) adminLink.style.display = 'block';
    }
    
    checkSessionAndLoadData();

    document.getElementById('logout-button').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });
  }
</script>
