---
// src/pages/schedule.astro
// No server-side code needed here anymore.
---

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule | Running Club</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body>
  <main class="container">
    <nav>
      <ul>
        <li><strong>Club Schedule</strong></li>
      </ul>
      <ul>
        <li><a href="/admin" id="admin-link" style="display: none;">Admin Dashboard</a></li>
        <li><a href="#" id="logout-button">Logout</a></li>
      </ul>
    </nav>

    <h1>Upcoming Events</h1>
    <p>This schedule is for members only. Welcome!</p>

    <article>
      <h2>Upcoming Practices</h2>
      <div id="practices-list">
        <p aria-busy="true">Loading practices...</p>
      </div>
    </article>

    <article>
      <h2>Upcoming Races</h2>
      <div id="races-list">
        <p aria-busy="true">Loading races...</p>
      </div>
    </article>
  </main>

  <script>
    import { supabase } from '../lib/supabase';
    import type { Event } from '../lib/types';

    const adminLink = document.getElementById('admin-link');
    const practicesList = document.getElementById('practices-list');
    const racesList = document.getElementById('races-list');

    // --- 1. Fetch and Display Events ---
    async function fetchAndDisplayEvents() {
      const { data: events, error } = await supabase
        .from('events')
        .select('*')
        .order('event_date', { ascending: true });

      if (error) {
        console.error("Error fetching events:", error.message);
        practicesList.innerHTML = '<p>Could not load practices.</p>';
        racesList.innerHTML = '<p>Could not load races.</p>';
        return;
      }

      const practices = events.filter(e => e.event_type === 'Practice');
      const races = events.filter(e => e.event_type === 'Race');

      // Display Practices
      if (practices.length > 0) {
        practicesList.innerHTML = `<ul>${practices.map((event) => `
          <li>
            <strong>${new Date(event.event_date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} at ${new Date(event.event_date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</strong>: ${event.title}
            ${event.description ? `<p><small>${event.description}</small></p>` : ''}
          </li>
        `).join('')}</ul>`;
      } else {
        practicesList.innerHTML = '<p>No new practices scheduled. Check back soon!</p>';
      }

      // Display Races
      if (races.length > 0) {
        racesList.innerHTML = `<ul>${races.map((event) => `
          <li>
            <strong>${new Date(event.event_date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</strong>: ${event.title}
            ${event.description ? `<p><small>${event.description}</small></p>` : ''}
          </li>
        `).join('')}</ul>`;
      } else {
        racesList.innerHTML = '<p>No new races scheduled. Check back soon!</p>';
      }
    }

    // --- 2. Protect the page and check for admin status ---
    async function checkSessionAndLoadData() {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        window.location.href = '/login';
        return; // Stop execution if not logged in
      }

      // If logged in, fetch the data
      fetchAndDisplayEvents();

      // And check if the user is an admin to show the admin link
      const { data: profile } = await supabase
        .from('profiles')
        .select('is_admin')
        .eq('id', user.id)
        .single();

      if (profile && profile.is_admin) {
        adminLink.style.display = 'block';
      }
    }
    checkSessionAndLoadData();

    // --- 3. Handle Logout ---
    const logoutButton = document.getElementById('logout-button');
    logoutButton.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });
  </script>
</body>
</html>
