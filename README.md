# Community Running Club Website Template

## 1. About the Project

This project is a customizable, open-source website template for community running clubs. The goal is to provide a central, secure, and easy-to-manage hub for student members, coaches, and parents that any club can deploy.

The site title and description can be easily changed from the admin dashboard.

---

## 2. Technology Choices

*   **Hosting:** [Render.com](https://render.com/) for continuous deployment and hosting.
*   **Frontend Framework:** [Astro](https://astro.build/) for a fast, modern static site build.
*   **Backend & Database:** [Supabase](https://supabase.com/) for authentication, database, and serverless functions.

---

## 3. Local Development Setup

To run this project on your local machine, follow these steps.

### Prerequisites

*   [Node.js](https://nodejs.org/) (v22.17.0 or higher is specified in `package.json`).
*   [npm](https://www.npmjs.com/) (comes with Node.js).
*   [Supabase CLI](https://supabase.com/docs/guides/cli) installed on your machine.

### Steps

1.  **Clone the Repository:**
    ```bash
    git clone https://github.com/fkcurrie/running-club.git
    cd running-club-site
    ```

2.  **Install Dependencies:**
    ```bash
    npm install
    ```

3.  **Set Up Supabase Backend:**
    *   Follow the [Backend Setup (Supabase)](#4-backend-setup-supabase) guide below to create your own Supabase project and configure the database and functions.

4.  **Set Up Environment Variables:**
    *   Create a new file named `.env` in the project root.
    *   Add your Supabase project URL, anonymous key, and service role key to this file. You can get these from your Supabase dashboard under `Project Settings > API`.
        ```
        # Supabase Credentials
        PUBLIC_SUPABASE_URL=[YOUR_SUPABASE_URL]
        PUBLIC_SUPABASE_ANON_KEY=[YOUR_SUPABASE_ANON_KEY]
        SUPABASE_SERVICE_ROLE_KEY=[YOUR_SERVICE_ROLE_KEY]
        ```

5.  **Run the Development Server:**
    ```bash
    npm run dev -- --host
    ```

6.  **Access the Site:**
    *   The server will now be running. You can access it in your browser at `http://<your-local-ip-address>:4173`.

---

## 4. Backend Setup (Supabase)

This project relies on Supabase for its backend. To create your own instance, follow these instructions.

### 4.1. Project Creation

1.  Go to [supabase.com](https://supabase.com) and create a new project.
2.  Keep the project dashboard open, as you will need details from it.

### 4.2. Database Schema

The entire database schema, including tables, row-level security policies, and triggers, can be set up with a single script.

1.  In your Supabase project, navigate to the **SQL Editor**.
2.  Click **"New query"**.
3.  Copy the entire content of the script below and paste it into the SQL Editor.
4.  **IMPORTANT:** In the `handle_new_user` function within the script, change the placeholder email `'your-admin-email@example.com'` to the email address you want to designate as the first site administrator.
5.  Click **"Run"**.

```sql
-- 1. PROFILES TABLE
-- This table stores public user data and custom fields like admin status.
CREATE TABLE public.profiles (
  id UUID NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name TEXT,
  grade INT,
  email TEXT,
  is_admin BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public profiles are viewable by everyone." ON public.profiles FOR SELECT USING (true);
CREATE POLICY "Users can update their own profile." ON public.profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Admins can manage all profiles." ON public.profiles FOR ALL USING ((SELECT is_admin FROM public.profiles WHERE id = auth.uid()) = true);

-- 2. FUNCTION TO CREATE A PROFILE FOR A NEW USER
-- This trigger automatically creates a profile entry when a new user signs up.
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, grade, email, is_admin)
  VALUES (
    new.id,
    new.raw_user_meta_data->>'full_name',
    (new.raw_user_meta_data->>'grade')::INT,
    new.email,
    false
  );
  -- Set the initial admin user if they match the specified email
  IF new.email = 'your-admin-email@example.com' THEN
    UPDATE public.profiles SET is_admin = true WHERE id = new.id;
  END IF;
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 3. TRIGGER FOR NEW USER FUNCTION
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- 4. EVENTS TABLE
CREATE TABLE public.events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  event_type TEXT,
  title TEXT,
  event_date TIMESTAMPTZ,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow authenticated users to view events" ON public.events FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admins to manage events" ON public.events FOR ALL TO authenticated USING ((SELECT is_admin FROM public.profiles WHERE id = auth.uid()) = true);

-- 5. ANNOUNCEMENTS TABLE
CREATE TABLE public.announcements (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  content TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.announcements ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow authenticated users to view announcements" ON public.announcements FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow admins to manage announcements" ON public.announcements FOR ALL TO authenticated USING ((SELECT is_admin FROM public.profiles WHERE id = auth.uid()) = true);

-- 6. RSVPS TABLE
CREATE TABLE public.rsvps (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  event_id BIGINT REFERENCES public.events(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (event_id, user_id)
);
ALTER TABLE public.rsvps ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow users to manage their own RSVPs" ON public.rsvps FOR ALL TO authenticated USING (auth.uid() = user_id);
CREATE POLICY "Allow admins to view all RSVPs" ON public.rsvps FOR SELECT TO authenticated USING ((SELECT is_admin FROM public.profiles WHERE id = auth.uid()) = true);

-- 7. SITE SETTINGS TABLE
CREATE TABLE public.site_settings (
  key TEXT PRIMARY KEY,
  value TEXT
);
ALTER TABLE public.site_settings ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read access to site settings" ON public.site_settings FOR SELECT USING (true);
CREATE POLICY "Allow admins to update site settings" ON public.site_settings FOR ALL TO authenticated USING ((SELECT is_admin FROM public.profiles WHERE id = auth.uid()) = true);
INSERT INTO public.site_settings (key, value)
VALUES
  ('site_title', 'Community Running Club'),
  ('site_description', 'Welcome to the official website of our running club!');
```

### 4.3. Edge Functions Setup

The admin functionality relies on two serverless Edge Functions. To deploy them, run the following commands from the `running-club-site` directory.

1.  **Log in to the Supabase CLI:**
    ```bash
    npx supabase login
    ```

2.  **Link your project:**
    *   Replace `[YOUR-PROJECT-ID]` with your actual Supabase project ID.
    ```bash
    npx supabase link --project-ref [YOUR-PROJECT-ID]
    ```

3.  **Set the Service Role Key:**
    *   First, create a file at `supabase/.env`.
    *   Add one line to it: `CUSTOM_SERVICE_ROLE_KEY=[YOUR-SERVICE-ROLE-KEY-HERE]`.
    *   Replace the placeholder with the `service_role` key from your Supabase project's API settings.
    *   Then, run the following command to securely upload the secret:
    ```bash
    npx supabase secrets set --env-file ./supabase/.env
    ```

4.  **Deploy the functions:**
    ```bash
    npx supabase functions deploy manage-user
    npx supabase functions deploy manage-content
    ```

Your backend is now fully configured.
